<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Punch Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 2rem; background: #f8f9fa; }
        .btn-lg { width: 180px; height: 60px; font-size: 1.3rem; margin: 0.5rem; }
        #graph-container { margin-top: 2rem; }
        #status { margin-top: 1rem; font-weight: bold; }
    </style>
</head>
<body>
<div class="container text-center">
    <h1 class="mb-4">Punch Tracker</h1>

    <div class="d-flex justify-content-center">
        <button id="startBtn" class="btn btn-success btn-lg" onclick="startWorkout()">Start Workout</button>
        <button id="stopBtn" class="btn btn-danger btn-lg" onclick="stopWorkout()">Stop Workout</button>
    </div>

    <div id="status" class="text-primary"></div>

    <h3 class="mt-5">Workout Sessions</h3>
    <div class="table-responsive">
        <div id="live-status" class="text-muted small mb-2" style="display:none;">
            üîÑ Live updating session list...
        </div>
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Session ID</th>
                </tr>
            </thead>
            <tbody  id="sessions-body">
                {% for session in sessions %}
                <tr style="cursor:pointer;" onclick="loadSession('{{ session.id }}')">
                    <td>{{ session.start_time }}</td>
                    <td>{{ session.end_time or 'Active' }}</td>
                    <td>{{ session.id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="graph-container" class="mt-4">
        <p>Select a session to view its graph.</p>
    </div>
</div>

<script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.6.0.min.js"></script>
<script>

let refreshInterval = null;


async function startWorkout() {
    const status = document.getElementById("status");
    showLiveStatus(true);
    status.innerHTML = '<span class="text-info">Connecting to BLE device and starting collection...</span>';
    try {
        const res = await fetch("/start", { method: "POST" });
        const data = await res.json();
        if (data.status === "started") {
            status.innerHTML = '<span class="text-success">‚úÖ Workout started. Collecting data...</span>';
            if (!refreshInterval) {
                refreshInterval = setInterval(refreshSessions, 5000);
            }
        } else {
            status.innerHTML = '<span class="text-danger">‚ö†Ô∏è Failed to start workout.</span>';
        }
    } catch (err) {
        status.innerHTML = '<span class="text-danger">‚ùå Error: ' + err + '</span>';
    }
}

async function stopWorkout() {
    const status = document.getElementById("status");
    showLiveStatus(false);
    status.innerHTML = '<span class="text-warning">Stopping collection...</span>';
    try {
        const res = await fetch("/stop", { method: "POST" });
        const data = await res.json();
        if (data.status === "stopped") {
            status.innerHTML = '<span class="text-success">üõë Workout stopped. Updating sessions...</span>';
            await refreshSessions();
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            status.innerHTML = '<span class="text-success">‚úÖ Workout stopped. Sessions updated.</span>';
        } else {
            status.innerHTML = '<span class="text-danger">‚ö†Ô∏è Failed to stop workout.</span>';
        }
    } catch (err) {
        status.innerHTML = '<span class="text-danger">‚ùå Error: ' + err + '</span>';
    }
}

async function loadSession(id) {
    const container = document.getElementById('graph-container');
    container.innerHTML = '<p class="text-muted">Loading...</p>';
    const res = await fetch(`/session/${id}`);
    const plotJSON = await res.json();
    container.innerHTML = "";
    Bokeh.embed.embed_item(plotJSON, "graph-container");
}
async function refreshSessions() {
    const tbody = document.getElementById("sessions-body");
    try {
        const res = await fetch("/sessions_fragment");
        const html = await res.text();
        tbody.innerHTML = html;
    } catch (err) {
        console.error("Failed to refresh sessions:", err);
    }
}

function showLiveStatus(show) {
    const el = document.getElementById("live-status");
    el.style.display = show ? "block" : "none";
}

</script>
</body>
</html>
